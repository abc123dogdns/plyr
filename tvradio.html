<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç»Ÿä¸€éŸ³è§†é¢‘æ’­æ”¾å™¨</title>
  <link href="https://cdn.jsdelivr.net/npm/plyr@3.6.2/dist/plyr.css" rel="stylesheet">
  <style>
    /* Basic styling for the body and controls */
    body {
      font-family: 'Inter', sans-serif; /* Using Inter font as per instructions */
      background: #f9f9f9;
      text-align: center;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh; /* Ensure full viewport height */
    }

    /* Styling for the main heading */
    h1 {
      color: #333;
      margin-bottom: 1.5rem;
    }

    /* Container for control buttons */
    .controls {
      display: flex;
      gap: 1rem; /* Space between buttons */
      margin-bottom: 2rem;
    }

    /* Styling for control buttons */
    .controls button {
      padding: 0.8rem 1.5rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px; /* Rounded corners */
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .controls button:hover {
      background-color: #0056b3;
      transform: translateY(-2px); /* Slight lift on hover */
    }

    .controls button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Playlist container */
    #playlist {
      max-width: 800px;
      width: 90%; /* Responsive width */
      margin: 1rem auto;
      list-style-type: none;
      padding: 0;
      background-color: #fff;
      border-radius: 10px; /* Rounded corners */
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden; /* Hide overflow for rounded corners */
    }

    /* Playlist items */
    #playlist li {
      cursor: pointer;
      margin: 0; /* Remove default margin */
      padding: 0.8rem 1.5rem;
      background-color: #fff;
      border-bottom: 1px solid #eee;
      text-align: left;
      transition: background-color 0.2s ease;
    }

    #playlist li:last-child {
      border-bottom: none; /* No border for the last item */
    }

    #playlist li:hover {
      background-color: #f0f0f0;
    }

    /* Video player container */
    #video-player {
      max-width: 800px;
      width: 90%; /* Responsive width */
      margin: 2rem auto;
      display: none; /* Hidden by default */
      border-radius: 10px; /* Rounded corners for the player */
      overflow: hidden; /* Ensure video player also has rounded corners */
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }

    /* Plyr video element */
    #plyr-video {
      width: 100%;
      height: auto; /* Maintain aspect ratio */
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      .controls {
        flex-direction: column;
        gap: 0.8rem;
      }
      .controls button {
        width: 100%; /* Full width buttons on small screens */
      }
      #playlist, #video-player {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸµğŸ¬ ç»Ÿä¸€éŸ³è§†é¢‘æ’­æ”¾å™¨</h1>
  <div class="controls">
    <button onclick="loadAudio()">æ’­æ”¾éŸ³é¢‘æ­Œå•</button>
    <button onclick="loadVideo()">æ’­æ”¾è§†é¢‘åˆ—è¡¨</button>
  </div>

  <ul id="playlist"></ul>
  <div id="video-player">
    <video id="plyr-video" class="plyr" controls></video>
  </div>

  <!-- Plyr.js library -->
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.6.2/dist/plyr.min.js"></script>
  <!-- HLS.js library for M3U8 support -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>

  <script>
    let player; // Plyr æ’­æ”¾å™¨å®ä¾‹
    let hls;    // HLS.js å®ä¾‹

    const proxy = "https://m3u8-http-proxy.abc123abc123.workers.dev"; // å¯ç•™ç©ºï¼Œè¡¨ç¤ºç›´æ¥æ’­æ”¾åŸå§‹é“¾æ¥

    /**
     * Initializes the Plyr player.
     * This function should be called only once.
     * åˆå§‹åŒ– Plyr æ’­æ”¾å™¨ã€‚
     * æ­¤å‡½æ•°åº”åªè¢«è°ƒç”¨ä¸€æ¬¡ã€‚
     */
    function initializePlayer() {
      const videoElement = document.getElementById('plyr-video');
      player = new Plyr(videoElement, {
        autoplay: true,
        controls: ['play', 'pause', 'rewind', 'fast-forward', 'current-time', 'duration', 'mute', 'volume', 'fullscreen', 'settings']
      });
      console.log("Plyr player initialized.");

      // Listen for when Plyr is ready
      // ç›‘å¬ Plyr ä½•æ—¶å‡†å¤‡å°±ç»ª
      player.on('ready', () => {
        console.log('Plyr is ready.');
      });

      // Listen for errors from Plyr
      // ç›‘å¬ Plyr çš„é”™è¯¯
      player.on('error', (event) => {
        console.error('Plyr error:', event);
      });
    }

    /**
     * Handles the source for the Plyr player, specifically for M3U8 using HLS.js.
     * å¤„ç† Plyr æ’­æ”¾å™¨çš„æºï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨ HLS.js æ’­æ”¾ M3U8ã€‚
     * @param {string} url - The URL of the media. åª’ä½“çš„ URLã€‚
     * @param {string} type - The type of media ('audio' or 'video'). åª’ä½“ç±»å‹ï¼ˆ'audio' æˆ– 'video'ï¼‰ã€‚
     */
    function setPlyrSource(url, type) {
      const videoElement = document.getElementById('plyr-video');

      // Pause current playback to prepare for source change
      // æš‚åœå½“å‰æ’­æ”¾ä»¥å‡†å¤‡æ›´æ¢æº
      player.pause();

      // Always destroy previous HLS instance if it exists
      // å¦‚æœå­˜åœ¨å…ˆå‰çš„ HLS å®ä¾‹ï¼Œåˆ™å§‹ç»ˆé”€æ¯å®ƒ
      if (hls) {
        hls.destroy();
        hls = null;
      }

      // Clear the native video element's source and reset its state
      // è¿™å¯¹äº HLS å’Œé HLS çš„è¿‡æ¸¡éƒ½è‡³å…³é‡è¦
      videoElement.removeAttribute('src'); // ç§»é™¤åŸç”Ÿè§†é¢‘å…ƒç´ çš„ src å±æ€§
      videoElement.load(); // åŠ è½½åª’ä½“å…ƒç´ ä»¥æ¸…é™¤å…¶å†…éƒ¨ç¼“å†²å’ŒçŠ¶æ€

      if (url.endsWith(".m3u8") && Hls.isSupported()) {
        // For M3U8, use HLS.js
        // å¯¹äº M3U8ï¼Œä½¿ç”¨ HLS.js
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(videoElement); // å°† HLS é™„åŠ åˆ°åŸç”Ÿåª’ä½“å…ƒç´ 

        hls.on(Hls.Events.MANIFEST_PARSED, function () {
          console.log('HLS.js: Manifest parsed. Attempting to play.'); // HLS.js: æ¸…å•å·²è§£æã€‚å°è¯•æ’­æ”¾ã€‚
          player.play().catch(err => console.error('Error playing media after HLS manifest parsed:', err)); // åœ¨ HLS æ¸…å•è§£æåæ’­æ”¾åª’ä½“æ—¶å‡ºé”™
        });

        hls.on(Hls.Events.ERROR, function (event, data) {
          console.error('HLS.js error:', data); // HLS.js é”™è¯¯
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                console.error('HLS.js: fatal network error encountered, trying to recover...'); // HLS.js: é‡åˆ°è‡´å‘½ç½‘ç»œé”™è¯¯ï¼Œæ­£åœ¨å°è¯•æ¢å¤...
                hls.recoverMediaError();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                console.error('HLS.js: fatal media error encountered, trying to recover...'); // HLS.js: é‡åˆ°è‡´å‘½åª’ä½“é”™è¯¯ï¼Œæ­£åœ¨å°è¯•æ¢å¤...
                hls.recoverMediaError();
                break;
              default:
                console.error('HLS.js: unrecoverable error, destroying HLS instance.'); // HLS.js: æ— æ³•æ¢å¤çš„é”™è¯¯ï¼Œæ­£åœ¨é”€æ¯ HLS å®ä¾‹ã€‚
                hls.destroy();
                break;
            }
          }
        });
        // Plyr will automatically pick up changes to the native video element
        // å¯¹äº HLSï¼Œæ— éœ€åœ¨æ­¤å¤„æ˜ç¡®è®¾ç½® player.sourceã€‚
      } else {
        // For non-M3U8 sources, set Plyr's source directly
        // å¯¹äºé M3U8 æºï¼Œç›´æ¥è®¾ç½® Plyr çš„æº
        let mimeType;
        if (url.endsWith(".mp3")) {
            mimeType = 'audio/mpeg';
        } else if (url.endsWith(".mp4")) {
            mimeType = 'video/mp4';
        } else {
            // Fallback for other common types or if type cannot be inferred from extension
            // å¦‚æœæ— æ³•ä»æ‰©å±•åæ¨æ–­ç±»å‹ï¼Œåˆ™å›é€€åˆ°å…¶ä»–å¸¸è§ç±»å‹ã€‚
            mimeType = type === 'audio' ? 'audio/mpeg' : 'video/mp4'; // é»˜è®¤ä¸ºå¸¸è§ç±»å‹
            console.warn(`Could not determine precise MIME type for URL: ${url}. Falling back to ${mimeType}`); // æ— æ³•ç¡®å®š URL çš„ç²¾ç¡® MIME ç±»å‹ã€‚å›é€€åˆ°
        }

        player.source = {
          type: type, // 'audio' or 'video'
          sources: [{
            src: url,
            type: mimeType
          }]
        };
        console.log("Setting Plyr source (non-HLS):", player.source); // è®¾ç½® Plyr æºï¼ˆé HLSï¼‰
        player.play().catch(err => console.error('Error playing media (non-HLS):', err)); // æ’­æ”¾åª’ä½“æ—¶å‡ºé”™ï¼ˆé HLSï¼‰
      }
    }

    /**
     * Loads audio playlist from 'aplayer_playlist.json'.
     * ä» 'aplayer_playlist.json' åŠ è½½éŸ³é¢‘æ’­æ”¾åˆ—è¡¨ã€‚
     */
    function loadAudio() {
      // Hide video player initially when loading new list
      // åŠ è½½æ–°åˆ—è¡¨æ—¶ï¼Œæœ€åˆéšè—è§†é¢‘æ’­æ”¾å™¨
      document.getElementById('video-player').style.display = 'none';
      // If a player exists and is playing, pause it.
      // å¦‚æœæ’­æ”¾å™¨å­˜åœ¨ä¸”æ­£åœ¨æ’­æ”¾ï¼Œåˆ™æš‚åœå®ƒã€‚
      if (player && !player.paused) {
          player.pause();
      }

      fetch("aplayer_playlist.json")
        .then(res => res.json())
        .then(data => {
          console.log("Loaded audio data:", data);
          const playlistElement = document.getElementById('playlist');
          playlistElement.innerHTML = ''; // Clear existing playlist // æ¸…ç©ºç°æœ‰æ’­æ”¾åˆ—è¡¨

          data.forEach(track => {
            console.log("Audio item:", track);
            // Apply proxy if needed (encoding the URL is important for proxy)
            // å¦‚æœéœ€è¦ï¼Œåº”ç”¨ä»£ç†ï¼ˆURL ç¼–ç å¯¹äºä»£ç†å¾ˆé‡è¦ï¼‰
            const mediaUrl = proxy ? proxy + encodeURIComponent(track.url) : track.url;

            const listItem = document.createElement('li');
            listItem.textContent = track.title || 'Untitled Audio'; // æœªå‘½åéŸ³é¢‘
            listItem.onclick = () => playAudio(mediaUrl); // Pass the processed URL // ä¼ é€’å¤„ç†åçš„ URL
            playlistElement.appendChild(listItem);
          });

          // Initialize player only if it hasn't been yet
          // ä»…åœ¨æ’­æ”¾å™¨å°šæœªåˆå§‹åŒ–æ—¶æ‰åˆå§‹åŒ–
          if (!player) {
            initializePlayer();
          }
        })
        .catch(err => console.error("Failed to load audio playlist:", err)); // åŠ è½½éŸ³é¢‘æ’­æ”¾åˆ—è¡¨å¤±è´¥
    }

    /**
     * Plays the selected audio track.
     * æ’­æ”¾é€‰å®šçš„éŸ³é¢‘è½¨é“ã€‚
     * @param {string} url - The URL of the audio track. éŸ³é¢‘è½¨é“çš„ URLã€‚
     */
    function playAudio(url) {
      console.log("Playing audio:", url); // æ­£åœ¨æ’­æ”¾éŸ³é¢‘
      document.getElementById('video-player').style.display = 'block'; // Show player // æ˜¾ç¤ºæ’­æ”¾å™¨
      setPlyrSource(url, 'audio');
    }

    /**
     * Loads video playlist from 'dplayer_playlist.json'.
     * ä» 'dplayer_playlist.json' åŠ è½½è§†é¢‘æ’­æ”¾åˆ—è¡¨ã€‚
     */
    function loadVideo() {
      // Hide video player initially when loading new list
      // åŠ è½½æ–°åˆ—è¡¨æ—¶ï¼Œæœ€åˆéšè—è§†é¢‘æ’­æ”¾å™¨
      document.getElementById('video-player').style.display = 'none';
      // If a player exists and is playing, pause it.
      // å¦‚æœæ’­æ”¾å™¨å­˜åœ¨ä¸”æ­£åœ¨æ’­æ”¾ï¼Œåˆ™æš‚åœå®ƒã€‚
      if (player && !player.paused) {
          player.pause();
      }

      fetch("dplayer_playlist.json")
        .then(res => res.json())
        .then(list => {
          console.log("Loaded video data:", list); // å·²åŠ è½½è§†é¢‘æ•°æ®
          const playlistElement = document.getElementById('playlist');
          playlistElement.innerHTML = ''; // Clear existing playlist // æ¸…ç©ºç°æœ‰æ’­æ”¾åˆ—è¡¨

          list.forEach(video => {
            console.log("Video item:", video); // è§†é¢‘é¡¹ç›®
            // Apply proxy if needed (encoding the URL is important for proxy)
            // å¦‚æœéœ€è¦ï¼Œåº”ç”¨ä»£ç†ï¼ˆURL ç¼–ç å¯¹äºä»£ç†å¾ˆé‡è¦ï¼‰
            const mediaUrl = proxy ? proxy + encodeURIComponent(video.url) : video.url;

            const listItem = document.createElement('li');
            listItem.textContent = video.title || 'Untitled Video'; // æœªå‘½åè§†é¢‘
            listItem.onclick = () => playVideo(mediaUrl); // Pass the processed URL // ä¼ é€’å¤„ç†åçš„ URL
            playlistElement.appendChild(listItem);
          });

          // Initialize player only if it's not yet initialized
          // ä»…åœ¨æ’­æ”¾å™¨å°šæœªåˆå§‹åŒ–æ—¶æ‰åˆå§‹åŒ–
          if (!player) {
            initializePlayer();
          }
        })
        .catch(err => console.error("Failed to load video playlist:", err)); // åŠ è½½è§†é¢‘æ’­æ”¾åˆ—è¡¨å¤±è´¥
    }

    /**
     * Plays the selected video track.
     * æ’­æ”¾é€‰å®šçš„è§†é¢‘è½¨é“ã€‚
     * @param {string} url - The URL of the video track. è§†é¢‘è½¨é“çš„ URLã€‚
     */
    function playVideo(url) {
      console.log("Playing video:", url); // æ­£åœ¨æ’­æ”¾è§†é¢‘
      document.getElementById('video-player').style.display = 'block'; // Show player // æ˜¾ç¤ºæ’­æ”¾å™¨
      setPlyrSource(url, 'video');
    }
  </script>
</body>
</html>
