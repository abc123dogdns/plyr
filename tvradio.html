<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>音视频播放器</title>
  <link href="https://cdn.jsdelivr.net/npm/plyr@3.6.2/dist/plyr.css" rel="stylesheet">
</head>
<body>
  <div>
    <h1>音视频播放器</h1>
    <div id="video-container">
      <video id="plyr-video" class="plyr" controls>
        <source id="video-source" type="video/mp4">
      </video>
    </div>
    <ul id="playlist"></ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/plyr@3.6.2/dist/plyr.js"></script>
  <script>
    let player;
    let hls = null; // 用于 HLS 流的处理

    const proxyUrl = "https://m3u8-http-proxy.abc123abc123.workers.dev"; // Cloudflare Worker 地址

    // 初始化播放器
    function initializePlayer() {
      player = new Plyr('#plyr-video', {
        controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
        autoplay: true
      });
    }

    // 设置播放器的音视频源
    function setPlyrSource(url) {
      const videoElement = document.getElementById('plyr-video');
      player.pause();

      if (hls) {
        hls.destroy();
        hls = null;
      }

      videoElement.removeAttribute('src');
      videoElement.load();

      if (url.endsWith(".m3u8") && Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(videoElement);

        hls.on(Hls.Events.MANIFEST_PARSED, function () {
          console.log('HLS.js: Manifest parsed. Attempting to play.');
          player.play().catch(err => console.error('Error playing media after HLS manifest parsed:', err));
        });

        hls.on(Hls.Events.ERROR, function (event, data) {
          console.error('HLS.js error:', data);
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                console.error('HLS.js: fatal network error encountered, trying to recover...');
                hls.recoverMediaError();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                console.error('HLS.js: fatal media error encountered, trying to recover...');
                hls.recoverMediaError();
                break;
              default:
                console.error('HLS.js: unrecoverable error, destroying HLS instance.');
                hls.destroy();
                break;
            }
          }
        });
      } else {
        player.source = {
          type: 'video',
          sources: [{
            src: url,
            type: 'video/mp4'
          }]
        };
        player.play().catch(err => console.error('Error playing media (non-HLS):', err));
      }
    }

    // 从 JSON 文件加载音视频列表
    function loadPlaylist() {
      fetch("dplayer_playlist.json")
        .then(res => res.json())
        .then(data => {
          const playlistElement = document.getElementById('playlist');
          playlistElement.innerHTML = '';

          data.forEach(track => {
            const mediaUrl = proxyUrl + "/http/" + encodeURIComponent(track.url);
            const listItem = document.createElement('li');
            listItem.textContent = track.title || 'Untitled Audio';
            listItem.onclick = () => setPlyrSource(mediaUrl);
            playlistElement.appendChild(listItem);
          });

          if (!player) {
            initializePlayer();
          }
        })
        .catch(err => console.error("Failed to load playlist:", err));
    }

    // 初始化加载音视频列表
    loadPlaylist();
  </script>
</body>
</html>
