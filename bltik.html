<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Bilibili 视频合集播放器（第三方API+CF Worker代理）</title>
  <link
    href="https://cdn.jsdelivr.net/npm/plyr@3.6.2/dist/plyr.css"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: sans-serif;
      max-width: 720px;
      margin: 20px auto;
      padding: 0 10px;
    }
    #playlist button {
      margin: 5px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #loading {
      margin-top: 10px;
      color: #666;
    }
  </style>
</head>
<body>
  <h2>Bilibili 视频合集播放器</h2>
  <div id="playlist"></div>
  <div id="loading" style="display:none;">加载中...</div>
  <video id="player" playsinline controls crossorigin></video>

  <script src="https://cdn.jsdelivr.net/npm/plyr@3.6.2/dist/plyr.polyfilled.js"></script>
  <script>
    // 读取环境变量 CF_WORKER_API，注意部署时PAGES的环境变量名一定要设置这个
    const WORKER_API = window.CF_WORKER_API || 'https://your-worker-name.workers.dev/api/bilibili';

    const plyrPlayer = new Plyr('#player');
    const playlistEl = document.getElementById('playlist');
    const loadingEl = document.getElementById('loading');

    // 示例BV号列表
    const bvList = ['BV1oKUPYNEPn', 'BV1mK4y1L7k8'];

    function createPlaylist() {
      playlistEl.innerHTML = '';
      bvList.forEach(bvid => {
        const btn = document.createElement('button');
        btn.textContent = bvid;
        btn.onclick = () => loadVideo(bvid);
        playlistEl.appendChild(btn);
      });
    }

    async function loadVideo(bvid) {
      loadingEl.style.display = 'block';
      try {
        const res = await fetch(`${WORKER_API}?bvid=${bvid}`);
        if (!res.ok) throw new Error(`请求失败: ${res.status}`);

        const data = await res.json();

        if (data.code !== 0 && data.error) {
          throw new Error(data.error || '接口返回错误');
        }

        // 解析第三方接口数据，获取标题和真实播放地址
        const title = data.data.title || '无标题';
        // 播放地址在 data.data.playurl 或 data.data.play_url 或类似字段，注意有的接口结构不一样
        // 这里用的是 iyk0.com 返回结构
        const playUrl = data.data.playurl?.url || data.data.playurl || data.data.play_url || '';

        if (!playUrl) throw new Error('未获取到有效播放地址');

        loadingEl.style.display = 'none';

        alert(`正在播放：${title}`);

        plyrPlayer.source = {
          type: 'video',
          sources: [{ src: playUrl, type: 'video/mp4' }],
          title: title,
        };
      } catch (e) {
        loadingEl.style.display = 'none';
        alert('加载失败: ' + e.message);
      }
    }

    createPlaylist();
  </script>
</body>
</html>
